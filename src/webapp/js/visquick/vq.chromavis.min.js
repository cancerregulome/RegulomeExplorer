//intialize with var data ={DATATYPE : "vq.models.FlexPlotData", CONTENTS : {DATAARRAY : data_array} };
// notifier = function(x,dx) where x = position within scroll bar range,  dx = total length of window in scale of scroll bar
//draw with draw (data ={DATATYPE : "vq.models.FlexPlotData", {DATAARRAY : data_array} }
//				and options = {plotHeight: xx, plotWidth : xx, verticalPadding: xx, 
//				horizontalPadding : xx , max_x_axis_value: xx, min_x_axis_value: xx,
//				maxRange: xx, minRange: xx, dblclick_notifier : function(x,dx),
//				fixedWindowWidth: xx, scaleMultiplier : xx, interval : xx, font : "fontname"}
//note dblclick_notifer is the last listed option.  This can be used to create a "zoom" effect by re-instanstiating the scroll bar with new parameters.
vq.ChromaVis=function(){vq.Vis.call(this),this.height(500),this.width(500),this.vertical_padding(30),this.horizontal_padding(30),this.max_x_axis_value(11),this.min_x_axis_value(0),this.context_height(50),this.max_y_axis_value(1),this.min_y_axis_value(1),this.max_y(1),this.min_y(1),this.uuid(vq.utils.VisUtils.guid())},vq.ChromaVis.prototype=pv.extend(vq.Vis),vq.ChromaVis.prototype.property("uuid",String).property("max_x_axis_value",Number).property("min_x_axis_value",Number).property("max_y_axis_value",Number).property("min_y_axis_value",Number).property("max_y",Number).property("min_y",Number).property("auto_scale_y",Boolean).property("auto_scale_x",Boolean).property("auto_update_scale_y",Boolean).property("context_height",Number),vq.ChromaVis.prototype.slaveTo=function(a){var b=this,c=!0,d=!0;arguments.length==3&&(c=arguments[1],d=arguments[2]),this.slaveX=c,this.slaveY=d,this.windowChangeHandler||(this.windowChangeHandler={}),this.windowChangeHandler[a]=function(a){b.windowchange(a)},vq.events.Dispatcher.addListener("chromavis_windowchange",a,b.windowChangeHandler[a])},vq.ChromaVis.prototype.unSlaveFrom=function(a){var b=this;!!b.windowChangeHandler&&!!b.windowChangeHandler[a]&&vq.events.Dispatcher.removeListener("chromavis_windowchange",a,b.windowChangeHandler[a])},vq.ChromaVis.prototype.windowchange=function(a){this.slaveRenderX=this.slaveX,this.slaveRenderY=this.slaveY,this.slaveRenderX&&this.posX.domain(a.pos.x.min,a.pos.x.max),this.slaveRenderY&&this._bl_data.yScale.domain(a.pos.y.min,a.pos.y.max),this.drawPanel.render(),this.slaveRenderX=!1,this.slaveRenderY=!1},vq.ChromaVis.prototype._setOptionDefaults=function(a){a.max_x_axis_value!=null&&this.max_x_axis_value(a.max_x_axis_value),a.min_x_axis_value!=null&&this.min_x_axis_value(a.min_x_axis_value),a.context_height!=null&&this.context_height(a.context_height),a.auto_scale_y!=null&&this.auto_scale_y(a.auto_scale_y),a.auto_scale_x!=null&&this.auto_scale_x(a.auto_scale_x),a.auto_update_scale_y!=null&&this.auto_update_scale_y(a.auto_update_scale_y),a.max_y_axis_value!=null&&this.max_y_axis_value(a.max_y_axis_value),a.min_y_axis_value!=null&&this.min_y_axis_value(a.min_y_axis_value),a.height!=null&&this.height(a.height),a.width!=null&&this.width(a.width),a.container&&this.container(a.container),a.vertical_padding!=null&&this.vertical_padding(a.vertical_padding),a.horizontal_padding!=null&&this.horizontal_padding(a.horizontal_padding)},vq.ChromaVis.prototype.draw=function(a){var b=this;this._bl_data=new vq.models.ChromaVisData(a),this._bl_data.isDataReady()&&(this._setOptionDefaults(b._bl_data),this._render())},vq.ChromaVis.prototype._render=function(){function L(){if(!(a.window.dx<2)){K();if(!b.dispatch_events)return;vq.events.Dispatcher.dispatch(new vq.events.Event("chromavis_windowchange",a.uuid(),{pos:{x:{min:a.context_posX.invert(a.window.x),max:a.context_posX.invert(a.window.dx+a.window.x)},y:{min:b.yScale.domain()[0],max:b.yScale.domain()[1]}}}))}}function K(){u.render()}function h(){a.show_vals=!1,a.mouse_x=null,c.render();return N}function g(){var d=-1;a.show_vals=!0,a.mouse_x=a.posX.invert(B.mouse().x),b.data_array.forEach(function(c){d=pv.search(c[b.data_contents_id].map(function(a){return a[b.x_column_id]}),a.mouse_x),d=d<0?-d-2:d,d<0&&(a.show_vals=!1),a.current_vals[c[b.data_label]]=d<0?0:c[b.data_contents_id][d][b.y_column_id]}),c.render(),S&&S.render();return N}var a=this,b=this._bl_data,c,d=55;this.show_vals=!1,this.current_vals={},a.mouse_x=null,a.slaveRenderX=!1,a.slaveRenderY=!1,this.visibleWidth=this.width()-2*this.horizontal_padding()-b.legend_width-d,this.visibleHeight=this.height()-this.vertical_padding()*2,this.focus_height=this.visibleHeight-this.context_height(),this.posX=pv.Scale.linear().range(0,a.visibleWidth),this.min_x=pv.min(b.data_array,function(a){return pv.min(a[b.data_contents_id],function(a){return a[b.x_column_id]})}),this.max_x=pv.max(b.data_array,function(a){return pv.max(a[b.data_contents_id],function(a){return a[b.x_column_id]})}),this.max_y(pv.max(b.data_array,function(a){return pv.max(a[b.data_contents_id],function(a){return a[b.y_column_id]})}));var e=a.auto_scale_x()?this.min_x:a.min_x_axis_value(),f=a.auto_scale_x()?this.max_x:a.max_x_axis_value();a.min_x_axis_value(e),a.max_x_axis_value(f),this.context_posX=pv.Scale.linear(a.min_x_axis_value(),a.max_x_axis_value()).range(0,a.visibleWidth),a.window={x:a.context_posX.range()[0]+(a.context_posX.range()[1]-a.context_posX.range()[0])*.2,dx:(a.context_posX.range()[1]-a.context_posX.range()[0])*.6},a.posX.domain(a.context_posX.invert(a.window.x),a.context_posX.invert(a.window.x+a.window.dx)),a.focus_window={x:0,dx:0};var k=pv.Scale.linear(a.min_x_axis_value(),a.max_x_axis_value()).range(0,a.visibleWidth),l=this.focus_height-4,m=a.min_y_axis_value(),o=a.auto_scale_y()?this.max_y():this.max_y_axis_value(),p=pv.Scale.linear(m,o).range(0,l);b.context_yScale=pv.Scale.linear(m,o).range(0,a.context_height()-1),this.max_y_axis_value(o),this.min_y_axis_value(m),b.yaxis_scale_type!=undefined&&b.yaxis_scale_type!=null&&b.yaxis_scale_type=="log"&&(m=m>0?m:1,b.base_value=b.base_value>0?b.base_value:m,p=pv.Scale.log(m,o).range(0,l).nice(),b.context_yScale=pv.Scale.log(m,o).range(0,a.context_height()-1).nice(),p.ticks=q(p.domain())),b.yScale=p;var q=function(a){var b=10,c=Math.log(b),d=function(a){return Math.log(a)/c},e=function(a){return Math.pow(b,a)};n=a[0]<0,i=Math.floor(n?-d(-a[0]):d(a[0])),j=Math.ceil(n?-d(-a[1]):d(a[1]));return function(){return pv.range(i,j+1,1).map(e)}},r=function(){var c=b.data_array.map(function(a){return a[b.data_contents_id].map(function(a){return a[b.x_column_id]})}),d,e;a.slaveRenderX?(d=a.posX.domain()[0],e=a.posX.domain()[1],a.window.x=a.context_posX(d),a.window.dx=a.context_posX(e)-a.window.x):(d=a.context_posX.invert(a.window.x),e=a.context_posX.invert(a.window.x+a.window.dx),a.posX.domain(d,e));var f=pv.min(pv.blend(c.map(function(a){return pv.max(a.filter(function(a){return a<d}))}))),g=pv.max(pv.blend(c.map(function(a){return pv.min(a.filter(function(a){return a>e}))}))),h=dd.map(function(a){var c={};c[b.data_label]=a[b.data_label],c[b.data_contents_id]=a[b.data_contents_id].filter(function(a){return a[b.x_column_id]<=g&&a[b.x_column_id]>=f});return c});if(!a.slaveRenderY)if(a.auto_update_scale_y()){var i=pv.max(h,function(a){return pv.max(a[b.data_contents_id],function(a){return a[b.y_column_id]})}),j=b.yScale.domain();b.yScale.domain(j[0],i)}else b.yScale.domain(a.min_y_axis_value(),a.max_y_axis_value());return h},s=(new pv.Panel).top(a.vertical_padding()).bottom(a.vertical_padding()).left(a.horizontal_padding()).right(a.horizontal_padding()).width(a.width()).height(a.height()).fillStyle(null).canvas(a.container()),t=s.add(pv.Panel).left(0).top(0),u=t.add(pv.Panel).width(a.visibleWidth).left(d);this.drawPanel=u;var v=t.add(pv.Panel).top(a.focus_height/3).height(a.focus_height/3).left(0).width(10),w=u.add(pv.Panel).top(0).left(0).height(a.focus_height),x=w.add(pv.Panel),y=w.add(pv.Panel).bottom(0).overflow("hidden");w.add(pv.Rule).left(0).add(pv.Rule).data(function(){return a.posX.ticks()}).left(a.posX).strokeStyle("#888").events("none").anchor("bottom").add(pv.Label).text(a.posX.tickFormat),c=w.add(pv.Panel);var z=c.add(pv.Rule).visible(function(){return a.mouse_x}).bottom(-10).height(10).strokeStyle("#888").events("none").left(function(){return a.posX(a.mouse_x)});z.anchor("bottom").add(pv.Label).text(function(){return a.mouse_x.toFixed(2)}).font("4pt");if(b.vertical_marker_array.length>0){var A=w.add(pv.Panel).overflow("hidden").data(b.vertical_marker_array);A.add(pv.Bar).lineWidth(2).left(function(b){return a.posX(b.value)}).fillStyle("rgba(240,0,0,0.6)").strokeStyle("rgba(240,0,0,0.6)").width(1).anchor("left").add(pv.Label).font("10px sans-serif").textAngle(-Math.PI/2).textAlign("center").textBaseline("bottom").textStyle("black").text(function(a){return a.id})}var B=y.add(pv.Panel).data(function(){return r()}).left(0).width(a.visibleWidth),C=b.strokeStyle,D=b.lineWidth,E=B.add(pv.Line).data(function(a){return a[b.data_contents_id]}).left(function(c){return a.posX(c[b.x_column_id])}).lineWidth(D).interpolate("cardinal").tension(.7).bottom(function(a){return b.yScale(a[b.y_column_id])}).strokeStyle(function(){return C.call(this.parent)});b.notifier!=undefined&&E.cursor("pointer").event("click",function(a,c){b.notifier(a,c)}),b.legend_width&&E.event("mousemove",g).event("mouseout",function(){a.show_vals=!1,a.mouse_x=null;return N}),b.yScale.domain()[0]<=b.base_value&&b.yScale.domain()[1]>=b.base_value?w.add(pv.Rule).bottom(function(){return b.yScale(b.base_value)}):w.add(pv.Rule).bottom(0),w.add(pv.Rule).data(function(){return b.yScale.ticks(5)}).bottom(function(a){return b.yScale(a)}).strokeStyle("#222").width(10).left(0).anchor("left").add(pv.Label).font("4pt").text(function(a,c){return b.yScale.tickFormat(a)}),v.add(pv.Label).textAngle(-Math.PI/2).font("4pt").textAlign("center").textBaseline("middle").text(b.y_axis_label);var F=u.add(pv.Panel).bottom(a.context_height()).height(15).left(0).width(a.visibleWidth).anchor("center").add(pv.Label).text(b.x_axis_label).font("4pt").textBaseline("middle"),G=u.add(pv.Panel).bottom(0).width(a.visibleWidth).left(0).height(a.context_height()),H=G.add(pv.Panel).bottom(0);if(b.vertical_marker_array.length>0){var I=H.add(pv.Panel).data(b.vertical_marker_array);I.add(pv.Bar).lineWidth(2).fillStyle("rgba(240,0,0,0.5)").left(function(a){return k(a.value)}).fillStyle("rgba(240,0,0,0.5)").width(1)}var J=H.add(pv.Panel).data(function(a){return b.data_array}).overflow("hidden").left(0);J.add(pv.Line).data(function(a){return a[b.data_contents_id]}).left(function(a){return k(a[b.x_column_id])}).bottom(function(a){return b.context_yScale(a[b.y_column_id])}).lineWidth(.5).antialias(!0).strokeStyle(function(){return C.call(this.parent)}),G.add(pv.Rule).left(0).add(pv.Rule).data(a.context_posX.ticks()).left(a.context_posX).strokeStyle("#888").anchor("bottom").add(pv.Label).text(a.context_posX.tickFormat),G.add(pv.Rule).bottom(0),G.add(pv.Panel).data(function(){return[a.window]}).cursor("crosshair").events("all").event("mousedown",pv.Behavior.select()).event("select",function(){K()}).event("selectend",function(){L()}).add(pv.Bar).left(function(a){return a.x}).width(function(a){return a.dx}).fillStyle("rgba(255, 128, 128, .4)").cursor("move").event("mousedown",pv.Behavior.drag()).event("drag",function(){K()}).event("dragend",function(){L()}),x.data(function(){return[a.focus_window]}).cursor("crosshair").events("all").event("mousedown",pv.Behavior.select()).event("selectend",function(){a.focus_window.dx<2?(a.focus_window={x:0,dx:0},w.render(),G.render()):(a.window={x:a.context_posX(a.posX.invert(a.focus_window.x)),dx:a.context_posX(a.posX.invert(a.focus_window.dx))-a.context_posX(a.posX.invert(0))},b.dispatch_events&&vq.events.Dispatcher.dispatch(new vq.events.Event("chromavis_windowchange",a.uuid(),{pos:{x:{min:a.posX.invert(a.focus_window.x),max:a.posX.invert(a.focus_window.dx+a.focus_window.x)},y:{min:b.yScale.domain()[0],max:b.yScale.domain()[1]}}})),a.focus_window={x:0,dx:0},u.render())}).add(pv.Bar).left(function(a){return a.x}).width(function(a){return a.dx}).fillStyle("rgba(128, 128, 255, .4)");var M=0;if(b.legend_width){M=12*b.data_array.length,x.event("mousemove",g).event("mouseout",h);var N=u.add(pv.Panel).left(a.visibleWidth).width(b.legend_width).top(10).height(M),O=N.add(pv.Panel).data(b.data_array).top(function(a){return this.index*12}).height(10);O.add(pv.Bar).left(2).width(10).height(2).top(2).strokeStyle(function(){return C.call(this.parent)}).anchor("right").add(pv.Label).text(function(c){return c[b.data_label]+(a.show_vals?" : "+a.current_vals[c[b.data_label]].toFixed(3):"")}).textAlign("left").font("10px monospace")}if(b.data_array[0][b.eri_id]!=undefined&&!isNaN(b.data_array[0][b.eri_id])){var P=pv.normalize(b.data_array,function(a){return a.eri}),Q=b.data_array.map(function(a,c){return{eri:P[c],label:a[b.data_label]}}).sort(function(a,b){return a.eri>b.eri?1:a.eri<b.eri?1:0});function R(){if(!a.show_vals)return[50];var c=pv.normalize(Q.map(function(b){return a.current_vals[b.label]})).reduce(function(a,c,d,e){return a+(Q[d][b.eri_id]-c)*(Q[d][b.eri_id]-c)},0);return[Math.sqrt(c)||0]}var S,T=0;if(b.eri_gauge){T=20;var U=70,V=pv.Scale.quantitative(0,b.eri_bubble_max).range("#2f2","#f22"),W=pv.Scale.linear(0,b.eri_bubble_max).range(0,U),X=u.add(pv.Panel).left(a.visibleWidth+5).width(80).top(M+5).height(T),Y=X.add(pv.Bar).bottom(9).width(U).height(2).left(10).strokeStyle("#333").lineWidth(1);X.add(pv.Label).bottom(-10).left(3).text("Prediction Match"),X.add(pv.Rule).left(10).height(8).bottom(6).strokeStyle("#333").lineWidth(2),X.add(pv.Rule).left(U+10).height(8).bottom(6).strokeStyle("#333").lineWidth(2);var Z=X.add(pv.Panel).bottom(10).width(U).height(2).left(10).strokeStyle(null);S=Z.add(pv.Dot).data(function(){return R()}).shape("circle").radius(4).strokeStyle("#333").lineWidth(1).fillStyle(function(a){return V(Math.min(b.eri_bubble_max,a))}).bottom(0).left(function(a){return W(Math.min(b.eri_bubble_max,a))})}var $=M+15+T,_=a.focus_height-$;function ba(a,b){var c=-1*Math.pow(a,2)/2;return b*Math.exp(c)}var bb=pv.range(-1,1.01,.01),bc=pv.Scale.linear(-1,1).range(0,80),bd=b.data_array.map(function(a){return isNaN(a[b.eri_id])?0:a[b.eri_id]}),be=pv.max(bd),bf=pv.Scale.linear(0,be).range(0,_-5),bg=u.add(pv.Panel).left(a.visibleWidth+5).width(80).top($).height(_);bg.add(pv.Panel).data(bd).top(1).strokeStyle("black").lineWidth(1).add(pv.Line).data(bb).bottom(function(a,b){return bf(ba(a,b))}).interpolate("cardinal").tension(.7).left(bc).strokeStyle(function(){return C.call(this.parent)}).lineWidth(b.lineWidth)}s.render()},vq.models.ChromaVisData=function(a){vq.models.VisData.call(this,a),this._setDataModel(),this.getDataType()=="vq.models.ChromaVisData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object.  Expected vq.models.ChromaVisData object.")},vq.models.ChromaVisData.prototype=pv.extend(vq.models.VisData),vq.models.ChromaVisData.prototype._build_data=function(a){this._processData(a),this.setDataReady(!0)},vq.models.ChromaVisData.prototype._setDataModel=function(){this._dataModel=[{label:"width",id:"PLOT.width",cast:Number,defaultValue:500},{label:"height",id:"PLOT.height",cast:Number,defaultValue:500},{label:"container",id:"PLOT.container",optional:!0},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:30},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:30},{label:"min_x_axis_value",id:"PLOT.min_x_axis_value",cast:Number,defaultValue:0},{label:"max_x_axis_value",id:"PLOT.max_x_axis_value",cast:Number,defaultValue:100},{label:"max_y_axis_value",id:"PLOT.max_y_axis_value",cast:Number,defaultValue:1},{label:"min_y_axis_value",id:"PLOT.min_y_axis_value",cast:Number,defaultValue:0},{label:"context_height",id:"PLOT.context_height",cast:Number,defaultValue:50},{label:"legend_width",id:"PLOT.legend_width",cast:Number,defaultValue:0},{label:"auto_scale_y",id:"PLOT.auto_scale_y",cast:Boolean,defaultValue:!1},{label:"auto_update_scale_y",id:"PLOT.auto_update_scale_y",cast:Boolean,defaultValue:!1},{label:"auto_scale_x",id:"PLOT.auto_scale_x",cast:Boolean,defaultValue:!1},{label:"label",id:"label",cast:String,defaultValue:""},{label:"type",id:"type",cast:String,defaultValue:"line"},{label:"x_column_id",id:"x_column_id",cast:String,defaultValue:"x"},{label:"y_column_id",id:"y_column_id",cast:String,defaultValue:"y"},{label:"eri_id",id:"eri_id",cast:String,defaultValue:"eri"},{label:"eri_gauge",id:"PLOT.eri_gauge",cast:Boolean,defaultValue:!1},{label:"y_axis_label",id:"y_axis_label",cast:String,defaultValue:"Intensity"},{label:"x_axis_label",id:"x_axis_label",cast:String,defaultValue:"Time(ms)"},{label:"strokeStyle",id:"stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:pv.Colors.category10()},{label:"lineWidth",id:"line_width",cast:vq.utils.VisUtils.wrapProperty,defaultValue:vq.utils.VisUtils.wrapProperty(1)},{label:"base_value",id:"base_value",cast:Number,defaultValue:0},{label:"yaxis_scale_type",id:"yaxis_scale_type",cast:String,defaultValue:"linear"},{label:"eri_bubble_max",id:"eri_bubble_max",cast:Number,defaultValue:.1},{label:"notifier",id:"notifier",cast:Function,optional:!0},{label:"tooltipItems",id:"tooltip_items",defaultValue:{X:"x",Value:"y"}},{label:"dispatch_events",id:"dispatch_events",cast:Boolean,defaultValue:!0},{label:"data_array",id:"data_array",defaultValue:[]},{label:"vertical_marker_array",id:"vertical_marker_array",cast:Object,defaulValue:[]},{label:"data_label",id:"data_label",defaultValue:"label"},{label:"data_contents_id",id:"data_contents_id",defaultValue:"data"}]}