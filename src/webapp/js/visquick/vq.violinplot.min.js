/**
*
*
* @class  An interactive violinplot.  A violinplot is a graph of nominal/ordinal data vs.  interval/continuous data.
*       The data is wiggled such that the distribution for any given value on the continuous scale is more apparent.
*        The "violin" (or stingray) shape is due to the empirical distribution calculated over the entire
*
*
*
* The JSON Object passed into the {@link ViolinPlot#draw} function as input to the visualization:
*
*
* <pre> {
*     data_array : {Array},
*	  xcolumnid : {string},
*	  ycolumnid : {string},
*	  valuecolumnid : {string},
*	  xcolumnvalue : {string},
*	  ycolumnvalue : {string},
*	  valuecolumnvalue : {string},
*	  tooltip_items : {Function},
*	  fill_style : {Function} or {string},
*	  stroke_style : {Function} or {string},
*	  radius : {Number},
*	  fill_style : {Function} or {string},
*	  stroke_style : {Function} or {string},
*     show_points : {Boolean},
*       notifier : {Function},
* 	  PLOT : {
*			width : {Number},
*			height : {Number},
*			container : {string}  or {HTMLElement}
*          vertical_padding : {Number},
*          horizontal_padding : {Number},
*			}
*	}
*	</pre>
*
*  @extends vq.Vis
*/vq.ViolinPlot=function(){vq.Vis.call(this),this.height(300),this.width(700),this.vertical_padding(20),this.horizontal_padding(30),this.selectedProbesetId("")},vq.ViolinPlot.prototype=pv.extend(vq.Vis),vq.ViolinPlot.prototype.property("selectedProbesetId"),vq.ViolinPlot.prototype._setOptionDefaults=function(a){a.selectedProbesetId&&(this._selectedProbesetId=a.selectedProbesetId),a.height!=null&&this.height(a.height),a.width!=null&&this.width(a.width),a.container!=null&&this.container(a.container),a.vertical_padding!=null&&this.vertical_padding(a.vertical_padding),a.horizontal_padding!=null&&this.horizontal_padding(a.horizontal_padding)},vq.ViolinPlot.prototype.onProbesetSelect=function(a){this.selectedProbesetId=a},vq.ViolinPlot.prototype.draw=function(a){function d(){var a=this.transform().invert(),c=b.width(),d=b.height(),e=(q-p)/2,f=q-e,g=2*e/d;r.domain(-1*(d*a.k+a.y)*g+e+f,-1*a.y*g+e+f),t.render()}var b=this;this.data=new vq.models.ViolinPlotData(a),this._setOptionDefaults(this.data);var c=this.container();if(this.data.isDataReady()){var e=this.data,f=e.COLUMNID.x,g=e.COLUMNID.y,h=e.COLUMNID.value,i=e.data,j=e.data_summary,k={},l=-9999999,m=9999999;typeof i[0][f]=="number"&&i.sort(function(a,b){return a[f]-b[f]});var n=pv.Scale.ordinal(i,function(a){return a[f]}).splitBanded(0,b.width(),.8),o=n.range().band/2;j.forEach(function(a){var b=pv.min(a[g]),c=pv.max(a[g]),d=a[g].length;a.bottom=b,a.top=c,a.mean=pv.mean(a[g]);if(d<=4)k[a[f]]=a,a.dist=[],a.bandScale=0,a.setSize=1,l=c>l?c:l,m=b<m?b:m;else{var e=pv.Scale.quantile(a[g]).quantiles(4).quantiles(),h=2*(e[3]-e[1])/Math.pow(d,.33);a.dist=pv.range(b-3*h/2,c+3*h/2,h).map(function(b){return{position:b+h/2,value:a[g].filter(function(a){return a>=b&&a<b+h}).length/a[g].length}}),a.bandScale=pv.Scale.linear(0,pv.max(a.dist,function(a){return a.value})).range(0,o),l=c+3*h/2>l?c+3*h/2:l,m=b-3*h/2<m?b-3*h/2:m,a.setSize=h,k[a[f]]=a}}),delete j;var p=m-(l-m)/15,q=l+(l-m)/15,r=pv.Scale.linear(p,q).range(0,b.height()),s;this._selectedProbesetId&&(s=this._selectedProbesetId);var t=(new pv.Panel).width(b.width()).height(b.height()).top(b.vertical_padding()).bottom(b.vertical_padding()).left(b.horizontal_padding()).right(b.horizontal_padding()).strokeStyle("#aaa").events("all").event("mousemove",pv.Behavior.point()).canvas(c);t.add(pv.Rule).data(function(){return r.ticks()}).bottom(r).strokeStyle(function(a){return a?"#ccc":"#999"}).anchor("left").add(pv.Label).text(r.tickFormat),t.add(pv.Label).text(e.COLUMNLABEL.y).font(b.font).textAlign("center").left(-24).bottom(this.height()/2).textAngle(-1*Math.PI/2),t.add(pv.Rule).data(n.domain()).left(function(a){return n(a)+o}).strokeStyle(function(a){return a?"#ccc":"#999"}).anchor("bottom").add(pv.Label),t.add(pv.Label).text(e.COLUMNLABEL.x).font(b.font).textAlign("center").bottom(-30).left(this.width()/2);var u=t.add(pv.Panel).events("all").overflow("hidden"),v=function(a){return pv.color(e._strokeStyle(a))},w=function(a){return pv.color(e._fillStyle(a))},x=u.add(pv.Panel).data(n.domain()).strokeStyle(null).fillStyle(null);x.add(pv.Bar).left(function(a){return n(a)}).visible(function(a){return k[a].dist.length}).width(o*2).height(2).bottom(function(a){return r(k[a].mean)-1}).fillStyle("rgb(255,0,0,0.6)"),x.add(pv.Line).data(function(a){return k[a].dist}).strokeStyle("black").lineWidth(1).left(function(a,b){return n(b)+o-k[b].bandScale(a.value)}).bottom(function(a){return r(a.position)}),x.add(pv.Line).data(function(a){return k[a].dist}).strokeStyle("black").lineWidth(1).left(function(a,b){return n(b)+o+k[b].bandScale(a.value)}).bottom(function(a){return r(a.position)}),e._showPoints&&x.add(pv.Dot).def("active",-1).data(i).left(function(a){if(k[a[f]].dist.length<1)return n(a[f])+o;var b=k[a[f]].dist[Math.floor((a[g]-k[a[f]].bottom)/k[a[f]].setSize)].value,c=k[a[f]].dist[Math.ceil((a[g]-k[a[f]].bottom)/k[a[f]].setSize)].value,d=(b+c)/3;return n(a[f])+o+k[a[f]].bandScale(Math.cos(this.index%(k[a[f]][g].length/3))*d)}).bottom(function(a){return r(a[g])}).shape(e._shape).fillStyle(w).strokeStyle(v).radius(e._radius).event("point",function(){return this.active(this.index).parent}).event("unpoint",function(){return this.active(-1).parent}).event("click",e._notifier).anchor("right").add(pv.Label).visible(function(){return this.anchorTarget().active()==this.index}).text(function(a){return e.COLUMNLABEL.value+" "+a[h]}),t.add(pv.Panel).left(0).bottom(0).events("all").event("mousedown",pv.Behavior.pan()).event("mousewheel",pv.Behavior.zoom()).event("pan",d).event("zoom",d),t.render()}},vq.models.ViolinPlotData=function(a){vq.models.VisData.call(this,a),this.setDataModel(),this.getDataType()=="vq.models.ViolinPlotData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object.  Expected vq.models.ViolinPlotData object.")},vq.models.ViolinPlotData.prototype=pv.extend(vq.models.VisData),vq.models.ViolinPlotData.prototype.setDataModel=function(){this._dataModel=[{label:"width",id:"PLOT.width",cast:Number,defaultValue:400},{label:"height",id:"PLOT.height",cast:Number,defaultValue:300},{label:"container",id:"PLOT.container",optional:!0},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:20},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:30},{label:"data",id:"data_array",defaultValue:[]},{label:"COLUMNID.x",id:"xcolumnid",cast:String,defaultValue:"X"},{label:"COLUMNID.y",id:"ycolumnid",cast:String,defaultValue:"Y"},{label:"COLUMNID.value",id:"valuecolumnid",cast:String,defaultValue:"VALUE"},{label:"COLUMNLABEL.x",id:"xcolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.y",id:"ycolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.value",id:"valuecolumnlabel",cast:String,defaultValue:""},{label:"tooltipItems",id:"tooltip_items",defaultValue:{X:"X",Y:"Y",Value:"VALUE"}},{label:"_fillStyle",id:"fill_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return pv.color("steelblue").alpha(.2)}},{label:"_strokeStyle",id:"stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"steelblue"}},{label:"_radius",id:"radius",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return 2}},{label:"_shape",id:"shape",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"dot"}},{label:"_showPoints",id:"show_points",cast:Boolean,defaultValue:!0},{label:"_notifier",id:"notifier",cast:Function,defaultValue:function(){return null}}]},vq.models.ViolinPlotData.prototype._build_data=function(a){var b=this;this._processData(a),this.COLUMNLABEL.x==""&&(this.COLUMNLABEL.x=this.COLUMNID.x),this.COLUMNLABEL.y==""&&(this.COLUMNLABEL.y=this.COLUMNID.y),this.COLUMNLABEL.value==""&&(this.COLUMNLABEL.value=this.COLUMNID.value),this.data_summary=[],pv.uniq(b.data,function(a){return a[b.COLUMNID.x]}).forEach(function(a){var c={},d=b.data.filter(function(c){return c[b.COLUMNID.x]==a});c[b.COLUMNID.x]=a,c[b.COLUMNID.y]=d.map(function(a){return a[b.COLUMNID.y]}),c[b.COLUMNID.value]=d.map(function(a){return a[b.COLUMNID.value]}),b.data_summary.push(c)}),this.data.length>0&&this.setDataReady(!0)}