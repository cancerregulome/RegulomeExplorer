/**
*
*
* @class  An interactive brush-link plot.
*
*
* The JSON Object passed into the {@link BrushLink#draw} function as input to the visualization:
*  
* 	<pre> {
*     	  data_array : {Array},
*	  columns : {Array}, 
*	  tooltipItems : {Function},
*	  notifier : {Function},
*	  PLOT : {
*		width : {int},
*		height : {int},
*		horizontal_padding : {int},
*		vertical_padding : {int},
*		container : {HTMLElement or string},
*		symmetric : {Boolean}
*		},
* 	  CONFIGURATION : {
*			multiple_id : {string},
*			color_id : {string},
*          		show_legend : {Boolean},
*          		AXES: {
*				label_font : {string},
*				}
*			}
*	}
*  </pre>
* @extends vq.Vis
*/vq.BrushLink=function(){vq.Vis.call(this),this.height(500),this.width(500),this.vertical_padding(10),this.horizontal_padding(10),this.symmetric(!1),this.selection([])},vq.BrushLink.prototype=pv.extend(vq.Vis),vq.BrushLink.prototype.property("selection").property("symmetric",Boolean),vq.BrushLink.prototype._setOptionDefaults=function(a){a.height!=null&&this.height(a.height),a.width!=null&&this.width(a.width),a.container&&this.container(a.container),a.vertical_padding!=null&&this.vertical_padding(a.vertical_padding),a.horizontal_padding!=null&&this.horizontal_padding(a.horizontal_padding),a.symmetric!=null&&this.symmetric(a.symmetric)},vq.BrushLink.prototype.draw=function(a){this._bl_data=new vq.models.BrushLinkData(a),this._bl_data.isDataReady()&&(this._data=this._bl_data._data,this._setOptionDefaults(this._bl_data),this.render())},vq.BrushLink.prototype.render=function(){function E(b,c){b.dx<5&&b.dy<5?j=null:(j=b,j.px=c.px,j.py=c.py,j.x1=o[c.px].invert(b.x),j.x2=o[c.px].invert(b.x+b.dx),j.y1=p[c.py].invert(a.height()-b.y-b.dy),j.y2=p[c.py].invert(a.height()-b.y),a.new_update=!0),A.context(null,0,function(){return this.render()})}function y(a){return x(a)?e(a):g}function x(a){return j?!(a[j.px]<j.x1||a[j.px]>j.x2||a[j.py]<j.y1||a[j.py]>j.y2):!0}function w(){var b=[];if(!j)return a._data;a.new_update&&(a.new_update=!1,b=a._data.filter(function(a){return!(a[j.px]<j.x1||a[j.px]>j.x2||a[j.py]<j.y1||a[j.py]>j.y2)}),a.selection(b))}var a=this,b=a._bl_data._columns,c=a._bl_data._notifier,d=a._bl_data._tooltipFormat,e=a._bl_data.color_scale,f=a._bl_data.shape_map,g=pv.rgb(144,144,144,.2),h=pv.rgb(255,144,144,.7),i=pv.colors("rgba(50%, 0%, 0%, .5)","rgba(0%, 50%, 0%, .5)","rgba(0%, 0%, 50%, .5)"),j,k=pv.numerate(b),l=a._bl_data.show_legend?25:0,m=(this.width()+2*this.horizontal_padding())*b.length,n=(this.height()+this.vertical_padding()*2)*b.length+l,o=pv.dict(b,function(b){return pv.Scale.linear(a._data,function(a){return a[b]}).range(0,a.width()).nice()}),p=pv.dict(b,function(b){return pv.Scale.linear(a._data,function(a){return a[b]}).range(0,a.height()).nice()}),q=(new pv.Panel).width(m).height(n).left(a.horizontal_padding()).top(a.vertical_padding()).canvas(a.container()),r=q.add(pv.Panel).data(b).top(function(){return this.index*(a.height()+2*a.vertical_padding())+a.vertical_padding()}).height(a.height()).add(pv.Panel).data(function(a){return b.map(function(b){return{px:b,py:a}})}).left(function(){return this.index*(a.width()+2*a.horizontal_padding())+a.horizontal_padding()}).width(a.width()),s=r.add(pv.Panel).events("all").strokeStyle("#aaa"),t=s.add(pv.Rule).data(function(a){return o[a.px].ticks(5)}).left(function(a,b){return o[b.px](a)}).strokeStyle("#eee"),u=s.add(pv.Rule).data(function(a){return p[a.py].ticks(5)}).bottom(function(a,b){return p[b.py](a)}).strokeStyle("#eee");this.symmetric()?(s.visible(function(a){return a.px!=a.py}),t.anchor("bottom").add(pv.Label).visible(function(){return r.parent.index==b.length-1&&!(r.index&1)}).text(function(a,b){return o[b.px].tickFormat(a)}),t.anchor("top").add(pv.Label).visible(function(){return r.parent.index==0&&!(r.index&1)}).text(function(a,b){return o[b.px].tickFormat(a)}),u.anchor("left").add(pv.Label).visible(function(){return r.index==0&&r.parent.index&1}).text(function(a,b){return p[b.py].tickFormat(a)}),u.anchor("right").add(pv.Label).visible(function(){return r.index==b.length-1&&!(r.parent.index&1)}).text(function(a,b){return p[b.py].tickFormat(a)})):(s.visible(function(a){return k[a.px]<k[a.py]}),t.anchor("bottom").add(pv.Label).text(function(a,b){return o[b.px].tickFormat(a)}),u.anchor("left").add(pv.Label).text(function(a,b){return p[b.py].tickFormat(a)}));var v=s.add(pv.Panel),z=s.add(pv.Panel),A=z.add(pv.Dot).data(a._data).left(function(a,b){return o[b.px](a[b.px])}).bottom(function(a,b){return p[b.py](a[b.py])}).size(10).fillStyle(y).strokeStyle(function(){return this.fillStyle()}).shape(f).events("none").cursor("pointer").events("painted").event("mouseover",pv.Behavior.hovercard({include_footer:!1,self_hover:!0,data_config:a._bl_data.tooltipItems})).event("click",c);v.data([{x:20,y:20,dx:80,dy:80}]).events("all").cursor("crosshair").event("mousedown",pv.Behavior.select()).event("selectstart",function(){return j=null,A.context(null,0,function(){return this.render()}),v.context(null,0,function(){return this.render()})}).event("select",E).event("selectend",w).add(pv.Bar).visible(function(a,b,c){return j&&j.px==c.px&&j.py==c.py}).left(function(a){return a.x}).top(function(a){return a.y}).width(function(a){return a.dx}).height(function(a){return a.dy}).fillStyle("rgba(0,0,0,.15)").strokeStyle("white").cursor("move").event("mousedown",pv.Behavior.drag()).event("dragend",w).event("drag",E),r.anchor("center").add(pv.Label).visible(function(a){return a.px==a.py}).font(a._bl_data.axes_label_font).text(function(a){return a.px.replace(/([WL])/," $1").toLowerCase()});if(this._bl_data.show_legend){var B=q.add(pv.Panel).bottom(0).height(l).strokeStyle("#222").width(a.width()*(a._bl_data._columns.length-1)).left(a.horizontal_padding()).lineWidth(1),C=B.add(pv.Panel).data(a._bl_data.unique_color_ids).strokeStyle(null).bottom(l/2).height(l/2-2).left(function(){return 30+this.index*40}).width(40);C.add(pv.Bar).left(2).width(15).bottom(0).fillStyle(function(b){var c={};c[a._bl_data.color_id]=b;return e(c)}),C.anchor("right").add(pv.Label).font("16px");if(a._bl_data.multiple_id){var D=B.add(pv.Panel).data(a._bl_data.unique_multiple_ids).bottom(0).height(l/2).strokeStyle(null).left(function(){return 30+this.index*40}).width(40);D.add(pv.Dot).left(12).strokeStyle("#222").fillStyle(function(){return this.strokeStyle()}).radius(l/4-2).shape(function(b){var c={};c[a._bl_data.multiple_id]=b;return f(c)}),D.anchor("right").add(pv.Label).font("16px")}}q.render()},vq.models.BrushLinkData=function(a){vq.models.VisData.call(this,a),this.setDataModel(),this.getDataType()=="vq.models.BrushLinkData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object.  Expected vq.models.BrushLinkData object.")},vq.models.BrushLinkData.prototype=pv.extend(vq.models.VisData),vq.models.BrushLinkData.prototype.setDataModel=function(){this._dataModel=[{label:"width",id:"PLOT.width",cast:Number,defaultValue:400},{label:"height",id:"PLOT.height",cast:Number,defaultValue:400},{label:"container",id:"PLOT.container",optional:!0},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:0},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:0},{label:"symmetric",id:"PLOT.symmetric",cast:Boolean,defaultValue:!1},{label:"_data",id:"data_array",defaultValue:[]},{label:"_columns",id:"columns",defaultValue:[]},{label:"_tooltipFormat",id:"tooltipFormat",cast:vq.utils.VisUtils.wrapProperty,defaultValue:null},{label:"tooltipItems",id:"tooltip_items",defaultValue:[]},{label:"color_id",id:"CONFIGURATION.color_id",cast:String,defaultValue:null},{label:"multiple_id",id:"CONFIGURATION.multiple_id",cast:String,defaultValue:null},{label:"show_legend",id:"CONFIGURATION.show_legend",cast:Boolean,defaultValue:!1},{label:"axes_label_font",id:"CONFIGURATION.AXES.label_font",cast:String,defaultValue:"bold 14px sans-serif"},{label:"_notifier",id:"notifier",cast:Function,defaultValue:function(){return null}}]},vq.models.BrushLinkData.prototype._build_data=function(a){var b=this;this.color_scale=vq.utils.VisUtils.wrapProperty(pv.color("red").alpha(.8));var c=["cross","triangle","square","cross","diamond","bar","tick"],d="circle";this._processData(a),this._data.length>0&&this.setDataReady(!0);if(this.color_id){this.unique_color_ids=pv.uniq(b._data,function(a){return a[b.color_id]});var e=pv.Colors.category10();this.color_scale=this.unique_color_ids.length>1?function(a){return e(a[b.color_id]).alpha(.8)}:this.color_scale}if(this.multiple_id){this.unique_multiple_ids=pv.uniq(b._data,function(a){return a[b.multiple_id]});var f=pv.dict(b.unique_multiple_ids,function(a){return c[this.index]});this.shape_map=b.unique_multiple_ids.length>1?function(a){return f[a[b.multiple_id]]}:function(){return d}}}